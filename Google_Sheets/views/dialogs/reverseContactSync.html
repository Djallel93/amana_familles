<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Google Sans", "Roboto", Arial, sans-serif;
            background: linear-gradient(135deg, #e8f0fe 0%, #f9fbff 100%);
            padding: 30px;
            color: #202124;
        }

        .form-container {
            background: #fff;
            padding: 30px 25px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #1a73e8;
            text-align: center;
            font-size: 1.6em;
            margin-top: 0;
            margin-bottom: 20px;
            position: relative;
        }

        h2::after {
            content: "";
            display: block;
            width: 60px;
            height: 3px;
            background: #1a73e8;
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .alert {
            padding: 14px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #e6f4ea;
            color: #137333;
            border-left: 4px solid #34a853;
        }

        .alert-error {
            background: #fce8e6;
            color: #a50e0e;
            border-left: 4px solid #ea4335;
        }

        .alert-warning {
            background: #fef7e0;
            color: #b06b00;
            border-left: 4px solid #fbbc04;
        }

        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #1a73e8;
        }

        .info-box h3 {
            color: #1a73e8;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .info-box p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box ul {
            margin: 10px 0 10px 20px;
            font-size: 14px;
        }

        .info-box li {
            margin: 5px 0;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a73e8, #1669c1);
            color: white;
            box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1669c1, #1557b0);
            box-shadow: 0 3px 6px rgba(26, 115, 232, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #202124;
            border: 1px solid #dadce0;
        }

        .btn-secondary:hover {
            background: #e8eaed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 25px 0;
        }

        .spinner {
            border: 3px solid #e0e0e0;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading p {
            font-size: 14px;
            color: #5f6368;
            margin: 0;
        }

        .results-box {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .results-box h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .results-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #1a73e8;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .details-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .detail-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-id {
            font-weight: 600;
            color: #1a73e8;
        }

        .detail-changes {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h2>üîÑ Sync Contact ‚Üí Feuille</h2>

        <div id="alertBox" class="alert"></div>

        <div class="info-box">
            <h3>‚ÑπÔ∏è Comment √ßa marche ?</h3>
            <p><strong>Cette fonction synchronise vos contacts Google vers la feuille.</strong></p>
            <ul>
                <li>R√©cup√®re tous les contacts du groupe "Famille dans le besoin"</li>
                <li>Compare les donn√©es des contacts avec celles de la feuille</li>
                <li>Met √† jour automatiquement la feuille si des diff√©rences sont d√©tect√©es</li>
                <li>Ajoute un commentaire pour chaque modification</li>
            </ul>
            <p><strong>üìù Champs synchronis√©s :</strong></p>
            <ul>
                <li>Nom, pr√©nom</li>
                <li>T√©l√©phone(s), email</li>
                <li>Adresse compl√®te</li>
                <li>Criticit√©</li>
                <li>Nombre d'adultes/enfants</li>
                <li>√âligibilit√© Zakat/Sadaqa</li>
                <li>Langue</li>
            </ul>
            <p style="margin-top: 15px;">
                <strong>‚è±Ô∏è Dur√©e estim√©e :</strong> ~5-30 secondes selon le nombre de familles
            </p>
        </div>

        <div class="button-group" id="actionButtons">
            <button type="button" class="btn-secondary" onclick="google.script.host.close()">Annuler</button>
            <button type="button" class="btn-primary" onclick="startSync()">‚ñ∂Ô∏è Lancer la synchronisation</button>
        </div>

        <div id="loadingBox" class="loading">
            <div class="spinner"></div>
            <p>Synchronisation en cours...</p>
        </div>

        <div id="resultsBox" class="results-box">
            <h3>üìä R√©sultats de la synchronisation</h3>
            <div class="results-stats" id="resultsStats"></div>
            <div id="detailsList"></div>
        </div>
    </div>

    <script>
        function startSync() {
            document.getElementById('alertBox').style.display = 'none';
            document.getElementById('loadingBox').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('resultsBox').style.display = 'none';

            google.script.run
                .withSuccessHandler(onSyncSuccess)
                .withFailureHandler(onSyncError)
                .reverseContactSync();
        }

        function onSyncSuccess(result) {
            document.getElementById('loadingBox').style.display = 'none';

            if (!result.success) {
                showAlert('error', `‚ùå Erreur: ${result.error}`);
                document.getElementById('actionButtons').style.display = 'flex';
                return;
            }

            const results = result.results;

            // Show stats
            const statsHtml = `
                <div class="stat-item">
                    <div class="stat-label">Total trait√©</div>
                    <div class="stat-value">${results.total}</div>
                </div>
                <div class="stat-item" style="border-left-color: #34a853;">
                    <div class="stat-label">‚úÖ Mis √† jour</div>
                    <div class="stat-value">${results.updated}</div>
                </div>
                <div class="stat-item" style="border-left-color: #9aa0a6;">
                    <div class="stat-label">‚ûñ Inchang√©s</div>
                    <div class="stat-value">${results.unchanged}</div>
                </div>
                <div class="stat-item" style="border-left-color: #ea4335;">
                    <div class="stat-label">‚ùå Erreurs</div>
                    <div class="stat-value">${results.errors}</div>
                </div>
            `;

            document.getElementById('resultsStats').innerHTML = statsHtml;

            // Show details if there are updates
            if (results.updated > 0 && results.details && results.details.length > 0) {
                const updatedDetails = results.details.filter(d => d.status === 'updated');

                let detailsHtml = '<div class="details-list"><strong>üìù Familles mises √† jour :</strong>';
                updatedDetails.forEach(detail => {
                    detailsHtml += `
                        <div class="detail-item">
                            <div class="detail-id">Famille ID: ${detail.familyId}</div>
                            <div class="detail-changes">${detail.changes.map(c => c.field).join(', ')}</div>
                        </div>
                    `;
                });
                detailsHtml += '</div>';

                document.getElementById('detailsList').innerHTML = detailsHtml;
            }

            document.getElementById('resultsBox').style.display = 'block';

            if (results.updated > 0) {
                showAlert('success', `‚úÖ Synchronisation termin√©e ! ${results.updated} famille(s) mise(s) √† jour.`);
            } else {
                showAlert('success', '‚úÖ Synchronisation termin√©e ! Aucune modification d√©tect√©e.');
            }

            // Show close button
            document.getElementById('actionButtons').innerHTML = `
                <button type="button" class="btn-primary" onclick="google.script.host.close()" style="width: 100%;">Fermer</button>
            `;
            document.getElementById('actionButtons').style.display = 'flex';
        }

        function onSyncError(error) {
            document.getElementById('loadingBox').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'flex';
            showAlert('error', `‚ùå Erreur syst√®me: ${error.message}`);
        }

        function showAlert(type, message) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.innerHTML = message;
            alertBox.style.display = 'block';
        }
    </script>
</body>

</html>