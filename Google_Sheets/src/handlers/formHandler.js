/**
 * @file src/handlers/formHandler.js
 * @description üìã Gestionnaire unifi√© pour toutes les soumissions de formulaire (INSERT et UPDATE)
 */

/**
 * üìù Gestionnaire unifi√© de soumission de formulaire
 * Route automatiquement vers INSERT ou UPDATE selon le contenu du formulaire
 * 
 * @param {Object} e - Objet √©v√©nement de soumission
 */
function onFormSubmit(e) {
    try {
        const sheet = e.range.getSheet();
        const sheetName = sheet.getName();
        const row = e.range.getRow();

        logInfo(`üìã Traitement de la feuille: ${sheetName}, ligne: ${row}`);

        // üö´ Ignorer la feuille Famille (feuille de sortie uniquement)
        if (sheetName === CONFIG.SHEETS.FAMILLE) {
            logInfo('‚è≠Ô∏è Feuille Famille ignor√©e - sortie uniquement');
            return;
        }

        // üìä Parser les donn√©es du formulaire
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        const values = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
        const formData = parseFormResponse(headers, values);

        // üö´ NOUVEAU: V√©rifier le refus de consentement
        if (isConsentRefused(formData)) {
            logInfo('üö´ Soumission ignor√©e: l\'utilisateur a refus√© le consentement');
            return; // Ne rien faire, ne pas notifier, ne pas logger
        }

        // üîç D√©tection automatique du type de formulaire
        const formType = detectFormType(formData, sheetName);

        logInfo(`üéØ Type de formulaire d√©tect√©: ${formType}`);

        // üîÄ Router vers le gestionnaire appropri√©
        if (formType === 'UPDATE') {
            processUpdate(formData, sheet, row);
        } else {
            processInsert(formData, sheet, row, sheetName);
        }

    } catch (error) {
        logError('‚ùå √âchec du traitement de la soumission', error);
        notifyAdmin('‚ùå Erreur de traitement', `Erreur: ${error.toString()}\nFeuille: ${e.range.getSheet().getName()}\nLigne: ${e.range.getRow()}`);
    }
}

/**
 * üîç D√©tecter s'il s'agit d'un formulaire INSERT ou UPDATE
 * 
 * @param {Object} formData - Donn√©es du formulaire pars√©es
 * @param {string} sheetName - Nom de la feuille
 * @returns {string} - 'INSERT' ou 'UPDATE'
 */
function detectFormType(formData, sheetName) {
    // üîç V√©rification 1: Le formulaire contient-il un ID de famille?
    const hasFamilyId = !!(formData.familyId || formData.id);

    if (hasFamilyId) {
        logInfo('üÜî ID famille d√©tect√© dans les donn√©es - formulaire UPDATE');
        return 'UPDATE';
    }

    // üîç V√©rification 2: Le nom de la feuille contient des mots-cl√©s de mise √† jour?
    const updateKeywords = [
        'update',
        'mise √† jour',
        'mise a jour',
        'maj',
        'modification',
        'ÿ™ÿ≠ÿØŸäÿ´',
        'actualisation',
        'modifier'
    ];

    const lowerName = sheetName.toLowerCase();
    const isUpdateSheet = updateKeywords.some(keyword => lowerName.includes(keyword));

    if (isUpdateSheet) {
        logInfo('üî§ Mot-cl√© de mise √† jour d√©tect√© dans le nom de la feuille - formulaire UPDATE');
        return 'UPDATE';
    }

    // ‚ûï Par d√©faut: formulaire INSERT
    logInfo('‚ûï Aucun indicateur de mise √† jour trouv√© - formulaire INSERT');
    return 'INSERT';
}

/**
 * ‚ûï Traiter une soumission INSERT (nouvelle famille)
 * 
 * @param {Object} formData - Donn√©es du formulaire pars√©es
 * @param {Sheet} sheet - Feuille source
 * @param {number} row - Num√©ro de ligne source
 * @param {string} sheetName - Nom de la feuille
 */
function processInsert(formData, sheet, row, sheetName) {
    try {
        logInfo('‚ûï Traitement d\'une soumission INSERT');

        // ‚úÖ Valider les champs requis
        const fieldValidation = validateRequiredFields(formData);
        if (!fieldValidation.isValid) {
            writeToFamilySheet(formData, {
                status: CONFIG.STATUS.REJECTED,
                comment: `Champs requis manquants: ${fieldValidation.errors.join(', ')}`,
                criticite: 0
            });
            notifyAdmin('‚ö†Ô∏è Soumission rejet√©e', `Raison: ${fieldValidation.errors.join(', ')}\nNom: ${formData.lastName} ${formData.firstName}`);
            return;
        }

        // üè† Valider l'adresse
        logInfo('üè† Validation de l\'adresse');
        const addressValidation = validateAddressAndGetQuartier(
            formData.address,
            formData.postalCode,
            formData.city
        );

        if (!addressValidation.isValid) {
            writeToFamilySheet(formData, {
                status: CONFIG.STATUS.REJECTED,
                comment: `Adresse invalide: ${addressValidation.error}`,
                criticite: 0
            });
            notifyAdmin('‚ö†Ô∏è Soumission rejet√©e', `Adresse invalide\nFamille: ${formData.lastName} ${formData.firstName}\nAdresse: ${formData.address}`);
            return;
        }

        logInfo('‚úÖ Adresse valid√©e avec succ√®s');

        // üìÑ Valider les documents
        logInfo('üìÑ Validation des documents');
        const docValidation = validateDocuments(
            formData.identityDoc,
            formData.cafDoc || formData.cafDocOptional,
            formData.resourceDoc
        );

        if (!docValidation.isValid) {
            writeToFamilySheet(formData, {
                status: CONFIG.STATUS.REJECTED,
                comment: `Documents invalides: ${docValidation.errors.join(', ')}`,
                quartierId: addressValidation.quartierId,
                criticite: 0
            });
            notifyAdmin('‚ö†Ô∏è Soumission rejet√©e', `Documents invalides\nFamille: ${formData.lastName} ${formData.firstName}\nErreurs: ${docValidation.errors.join(', ')}`);
            return;
        }
        logInfo('‚úÖ Documents valid√©s avec succ√®s');

        logInfo('üîç V√©rification des doublons');
        // üîç V√©rifier les doublons
        const duplicate = findDuplicateFamily(
            formData.phone,
            formData.lastName,
            formData.email
        );

        if (duplicate.exists) {
            updateExistingFamily(duplicate, formData, addressValidation, docValidation);
            notifyAdmin('üîÑ Famille mise √† jour', `ID: ${duplicate.id}\nNom: ${formData.lastName} ${formData.firstName}\nT√©l√©phone: ${normalizePhone(formData.phone)}`);
        } else {
            const familyId = generateFamilyId();
            writeToFamilySheet(formData, {
                status: CONFIG.STATUS.IN_PROGRESS,
                familyId: familyId,
                quartierId: addressValidation.quartierId,
                quartierName: addressValidation.quartierName,
                identityIds: docValidation.identityIds,
                cafIds: docValidation.cafIds,
                resourceIds: docValidation.resourceIds,
                criticite: 0
            });
            notifyAdmin('‚úÖ Nouvelle soumission', `ID: ${familyId}\nNom: ${formData.lastName} ${formData.firstName}\nT√©l√©phone: ${normalizePhone(formData.phone)}\nAdresse: ${formData.address}, ${formData.postalCode} ${formData.city}\nQuartier: ${addressValidation.quartierName || 'Non assign√©'}`);
        }

        logInfo('‚úÖ Soumission INSERT trait√©e avec succ√®s');

    } catch (error) {
        logError('‚ùå √âchec du traitement INSERT', error);
        notifyAdmin('‚ùå Erreur INSERT', `Erreur: ${error.toString()}\nFamille: ${formData.lastName} ${formData.firstName}`);
        throw error;
    }
}

/**
 * ‚úèÔ∏è Traiter une soumission UPDATE (famille existante)
 * 
 * @param {Object} formData - Donn√©es du formulaire pars√©es
 * @param {Sheet} sheet - Feuille source
 * @param {number} row - Num√©ro de ligne source
 */
function processUpdate(formData, sheet, row) {
    try {
        logInfo('‚úèÔ∏è Traitement d\'une soumission UPDATE');

        // üÜî Extraire l'ID de famille
        const familyId = formData.familyId || formData.id;

        if (!familyId) {
            logError('‚ùå Formulaire de mise √† jour sans ID famille', { row });
            notifyAdmin('‚ùå Update √©chou√©e', `ID famille manquant dans le formulaire\nLigne: ${row}`);
            return;
        }

        // üî® Construire les donn√©es de mise √† jour (uniquement les champs non vides)
        const updateData = buildUpdateData(formData);

        if (Object.keys(updateData).length === 0) {
            logError('‚ùå Formulaire de mise √† jour sans donn√©es', { familyId });
            notifyAdmin('‚ùå Update √©chou√©e', `Aucune donn√©e √† mettre √† jour pour ${familyId}`);
            return;
        }

        // ‚úÖ Valider les donn√©es de mise √† jour
        const validation = validateUpdateData(updateData);
        if (!validation.isValid) {
            logError('‚ùå Validation de la mise √† jour √©chou√©e', { familyId, error: validation.error });
            notifyAdmin('‚ùå Update √©chou√©e', `${familyId}: ${validation.error}`);
            return;
        }

        // üîÑ Effectuer la mise √† jour
        const result = updateFamilyById(familyId, updateData);

        if (result.success) {
            logInfo('‚úÖ Formulaire de mise √† jour trait√© avec succ√®s', {
                familyId,
                updatedFields: result.updatedFields
            });
            notifyAdmin(
                '‚úÖ Famille mise √† jour via formulaire',
                `ID: ${familyId}\nChamps mis √† jour: ${result.updatedFields.join(', ')}`
            );
        } else {
            logError('‚ùå √âchec du traitement de la mise √† jour', { familyId, error: result.error });
            notifyAdmin('‚ùå Update √©chou√©e', `ID: ${familyId}\nErreur: ${result.error}`);
        }

    } catch (error) {
        logError('‚ùå √âchec du traitement UPDATE', error);
        notifyAdmin('‚ùå Erreur UPDATE', `Erreur: ${error.toString()}`);
        throw error;
    }
}

/**
 * üî® Construire l'objet de donn√©es de mise √† jour depuis les donn√©es du formulaire
 * 
 * @param {Object} formData - Donn√©es brutes du formulaire
 * @returns {Object} - Donn√©es de mise √† jour nettoy√©es
 */
function buildUpdateData(formData) {
    const updateData = {};

    const fieldMapping = {
        lastName: 'lastName',
        firstName: 'firstName',
        phone: 'phone',
        phoneBis: 'phoneBis',
        email: 'email',
        address: 'address',
        postalCode: 'postalCode',
        city: 'city',
        nombreAdulte: 'nombreAdulte',
        nombreEnfant: 'nombreEnfant',
        circonstances: 'circonstances',
        ressentit: 'ressentit',
        specificites: 'specificites',
        criticite: 'criticite'
    };

    Object.keys(fieldMapping).forEach(key => {
        const value = formData[key];

        // ‚è≠Ô∏è Ignorer les valeurs vides
        if (value === undefined || value === null || value === '') {
            return;
        }

        // üî¢ Parser les nombres
        if (key === 'nombreAdulte' || key === 'nombreEnfant' || key === 'criticite') {
            const parsed = parseInt(value);
            if (!isNaN(parsed)) {
                updateData[fieldMapping[key]] = parsed;
            }
        } else {
            updateData[fieldMapping[key]] = value;
        }
    });

    return updateData;
}

/**
 * ‚úÖ Valider les donn√©es de mise √† jour
 * 
 * @param {Object} updateData - Donn√©es de mise √† jour √† valider
 * @returns {Object} - {isValid: boolean, error: string}
 */
function validateUpdateData(updateData) {
    // ‚úâÔ∏è Valider l'email si fourni
    if (updateData.email && !isValidEmail(updateData.email)) {
        return {
            isValid: false,
            error: 'Email invalide'
        };
    }

    // üìû Valider le t√©l√©phone si fourni
    if (updateData.phone && !isValidPhone(updateData.phone)) {
        return {
            isValid: false,
            error: 'T√©l√©phone invalide'
        };
    }

    // ‚ö†Ô∏è Valider la criticit√© si fournie
    if (updateData.criticite !== undefined) {
        if (isNaN(updateData.criticite) ||
            updateData.criticite < CONFIG.CRITICITE.MIN ||
            updateData.criticite > CONFIG.CRITICITE.MAX) {
            return {
                isValid: false,
                error: 'Criticit√© invalide (doit √™tre entre 0 et 5)'
            };
        }
    }

    return { isValid: true };
}