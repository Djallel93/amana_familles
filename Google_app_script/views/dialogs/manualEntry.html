<!-- views/dialogs/manualEntry.html -->
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('assets/css/styles').getContent(); ?>
</head>

<body>
    <div class="form-container">
        <h2>üìù Inscription Manuelle - Famille</h2>

        <div id="alertBox" class="alert"></div>
        <div id="loadingBox" class="loading">
            <div class="spinner"></div>
            <p>Traitement en cours...</p>
        </div>

        <form id="familyForm">
            <!-- Informations Personnelles -->
            <div class="section-title">Informations Personnelles</div>

            <div class="form-group">
                <label class="required">Nom de famille</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>

            <div class="form-group">
                <label class="required">Pr√©nom</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>

            <div class="form-group">
                <label class="required">T√©l√©phone</label>
                <input type="tel" id="phone" name="phone" required placeholder="Ex: 0612345678">
            </div>

            <div class="form-group">
                <label>T√©l√©phone secondaire</label>
                <input type="tel" id="phoneBis" name="phoneBis" placeholder="Optionnel">
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" name="email" placeholder="Optionnel">
            </div>

            <!-- Adresse -->
            <div class="section-title">Adresse</div>

            <div class="form-group">
                <label class="required">Adresse compl√®te</label>
                <input type="text" id="address" name="address" required placeholder="Ex: 1 Rue de la Paix">
            </div>

            <div class="form-group">
                <label class="required">Code postal</label>
                <input type="text" id="postalCode" name="postalCode" required placeholder="Ex: 44000">
            </div>

            <div class="form-group">
                <label class="required">Ville</label>
                <input type="text" id="city" name="city" required placeholder="Ex: Nantes">
            </div>

            <!-- Composition du foyer -->
            <div class="section-title">Composition du Foyer</div>

            <div class="form-group">
                <label class="required">Nombre d'adultes</label>
                <input type="number" id="nombreAdulte" name="nombreAdulte" min="0" required value="1">
            </div>

            <div class="form-group">
                <label class="required">Nombre d'enfants</label>
                <input type="number" id="nombreEnfant" name="nombreEnfant" min="0" required value="0">
            </div>

            <!-- Informations Compl√©mentaires -->
            <div class="section-title">Informations Compl√©mentaires (Optionnel)</div>

            <div class="form-group">
                <label>Circonstances / Situation actuelle</label>
                <textarea id="circonstances" name="circonstances"
                    placeholder="D√©crivez bri√®vement la situation de la famille"></textarea>
            </div>

            <div class="form-group">
                <label>Ressentit</label>
                <textarea id="ressentit" name="ressentit" placeholder="Notes ou observations"></textarea>
            </div>

            <div class="form-group">
                <label>Sp√©cificit√©s</label>
                <textarea id="specificites" name="specificites"
                    placeholder="Besoins particuliers, allergies, etc."></textarea>
            </div>

            <!-- Buttons -->
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="google.script.host.close()">Annuler</button>
                <button type="submit" class="btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>

    <script>
        document.getElementById('familyForm').addEventListener('submit', function (e) {
            e.preventDefault();

            document.getElementById('loadingBox').style.display = 'block';
            document.getElementById('alertBox').style.display = 'none';

            const formData = {
                lastName: document.getElementById('lastName').value.trim(),
                firstName: document.getElementById('firstName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                phoneBis: document.getElementById('phoneBis').value.trim(),
                email: document.getElementById('email').value.trim(),
                address: document.getElementById('address').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                city: document.getElementById('city').value.trim(),
                nombreAdulte: parseInt(document.getElementById('nombreAdulte').value),
                nombreEnfant: parseInt(document.getElementById('nombreEnfant').value),
                circonstances: document.getElementById('circonstances').value.trim(),
                ressentit: document.getElementById('ressentit').value.trim(),
                specificites: document.getElementById('specificites').value.trim()
            };

            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onFailure)
                .processManualEntry(formData);
        });

        function onSuccess(result) {
            document.getElementById('loadingBox').style.display = 'none';
            const alertBox = document.getElementById('alertBox');

            if (result.success) {
                alertBox.className = 'alert alert-success';
                alertBox.style.display = 'block';
                alertBox.innerHTML = `<strong>‚úÖ Succ√®s!</strong><br>Famille enregistr√©e avec succ√®s.<br>ID: <strong>${result.familyId}</strong><br>${result.quartierName ? 'Quartier: ' + result.quartierName : ''}`;
                document.getElementById('familyForm').reset();

                setTimeout(() => {
                    google.script.host.close();
                }, 3000);

            } else if (result.duplicate) {
                alertBox.className = 'alert alert-warning';
                alertBox.style.display = 'block';
                alertBox.innerHTML = `<strong>‚ö†Ô∏è Attention!</strong><br>${result.message}`;
            } else {
                alertBox.className = 'alert alert-error';
                alertBox.style.display = 'block';
                alertBox.innerHTML = `<strong>‚ùå Erreur</strong><br>${result.error}`;
            }
        }

        function onFailure(error) {
            document.getElementById('loadingBox').style.display = 'none';
            const alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert alert-error';
            alertBox.style.display = 'block';
            alertBox.innerHTML = `<strong>‚ùå Erreur Syst√®me</strong><br>${error.message}`;
        }
    </script>
</body>

</html>